# 手动构建并发布全平台 Release 到 GitHub
# 版本号格式: 1.YYYYMMDDHHmm（如 1.202601011200）
# 在 Actions 页选择此 workflow，点击 Run workflow，勾选要构建的平台（可多选）

name: Build Release (全平台)

on:
  workflow_dispatch:
    inputs:
      build_android:
        description: '构建 Android (APK)'
        required: false
        default: true
        type: boolean
      build_windows:
        description: '构建 Windows'
        required: false
        default: true
        type: boolean
      build_macos:
        description: '构建 macOS'
        required: false
        default: false
        type: boolean
      build_linux:
        description: '构建 Linux'
        required: false
        default: false
        type: boolean

env:
  FLUTTER_VERSION: '3.38.9'
  PROJECT_DIR: flutter_app

jobs:
  prepare:
    name: 生成版本号
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.version.outputs.version }}
    steps:
      - name: 生成版本号 (1.YYYYMMDDHHmm)
        id: version
        run: |
          TIMESTAMP=$(date -u +%Y%m%d%H%M)
          echo "version=1.${TIMESTAMP}" >> $GITHUB_OUTPUT
          echo "Generated version: 1.${TIMESTAMP}"

  build-android:
    name: 构建 Android Release
    runs-on: ubuntu-latest
    needs: prepare
    if: ${{ github.event.inputs.build_android == 'true' }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: 安装 Java 17
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'

      - name: 安装 Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}
          cache: true

      - name: 获取依赖
        working-directory: ${{ env.PROJECT_DIR }}
        run: flutter pub get

      # 使用固定的 release 签名，保证每次打包签名一致（需在仓库 Settings → Secrets 配置）
      - name: 配置 Android Release 签名
        working-directory: ${{ env.PROJECT_DIR }}/android
        run: |
          echo "${{ secrets.ANDROID_KEYSTORE_BASE64 }}" | base64 -d > app/upload-keystore.jks
          cat >> key.properties << EOF
          storePassword=${{ secrets.ANDROID_KEYSTORE_PASSWORD }}
          keyPassword=${{ secrets.ANDROID_KEY_PASSWORD }}
          keyAlias=${{ secrets.ANDROID_KEY_ALIAS }}
          storeFile=app/upload-keystore.jks
          EOF
        if: ${{ secrets.ANDROID_KEYSTORE_BASE64 != '' }}

      - name: 构建 Android APK (Release)
        working-directory: ${{ env.PROJECT_DIR }}
        run: flutter build apk --release

      - name: 上传 Android 产物
        uses: actions/upload-artifact@v4
        with:
          name: android-release
          path: ${{ env.PROJECT_DIR }}/build/app/outputs/flutter-apk/app-release.apk

  build-windows:
    name: 构建 Windows Release
    runs-on: windows-latest
    needs: prepare
    if: ${{ github.event.inputs.build_windows == 'true' }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: 安装 Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}
          cache: true

      - name: 获取依赖
        working-directory: ${{ env.PROJECT_DIR }}
        run: flutter pub get

      - name: 构建 Windows (Release)
        working-directory: ${{ env.PROJECT_DIR }}
        run: flutter build windows --release

      - name: 打包 Windows 发布目录
        shell: pwsh
        run: |
          Compress-Archive -Path "${{ env.PROJECT_DIR }}\build\windows\x64\runner\Release\*" -DestinationPath windows-release.zip -Force

      - name: 上传 Windows 产物
        uses: actions/upload-artifact@v4
        with:
          name: windows-release
          path: windows-release.zip

  build-macos:
    name: 构建 macOS Release
    runs-on: macos-latest
    needs: prepare
    if: ${{ github.event.inputs.build_macos == 'true' }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: 安装 Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}
          cache: true

      - name: 获取依赖
        working-directory: ${{ env.PROJECT_DIR }}
        run: flutter pub get

      - name: 构建 macOS (Release)
        working-directory: ${{ env.PROJECT_DIR }}
        run: flutter build macos --release

      - name: 打包 macOS 应用
        run: |
          cd ${{ env.PROJECT_DIR }}/build/macos/Build/Products/Release
          zip -r ../../../../../../macos-release.zip . -x "*.dSYM/*"

      - name: 上传 macOS 产物
        uses: actions/upload-artifact@v4
        with:
          name: macos-release
          path: ${{ env.PROJECT_DIR }}/macos-release.zip

  build-linux:
    name: 构建 Linux Release
    runs-on: ubuntu-latest
    needs: prepare
    if: ${{ github.event.inputs.build_linux == 'true' }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: 安装 Linux 桌面依赖
        run: |
          sudo apt-get update -y
          sudo apt-get install -y clang cmake ninja-build pkg-config libgtk-3-dev libstdc++-12-dev

      - name: 安装 Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}
          cache: true

      - name: 获取依赖
        working-directory: ${{ env.PROJECT_DIR }}
        run: flutter pub get

      - name: 构建 Linux (Release)
        working-directory: ${{ env.PROJECT_DIR }}
        run: flutter build linux --release

      - name: 打包 Linux 发布目录
        run: |
          cd ${{ env.PROJECT_DIR }}/build/linux/x64/release/bundle
          zip -r ../../../../../../linux-release.zip .

      - name: 上传 Linux 产物
        uses: actions/upload-artifact@v4
        with:
          name: linux-release
          path: ${{ env.PROJECT_DIR }}/linux-release.zip

  release:
    name: 创建 GitHub Release
    runs-on: ubuntu-latest
    needs: [prepare, build-android, build-windows, build-macos, build-linux]
    # 任意一个平台构建成功即发布（其余可失败或未勾选）
    if: |
      always() &&
      (needs.build-android.result == 'success' || needs.build-windows.result == 'success' || needs.build-macos.result == 'success' || needs.build-linux.result == 'success')
    permissions:
      contents: write
    steps:
      - name: 下载 Android 产物
        if: needs.build-android.result == 'success'
        uses: actions/download-artifact@v4
        with:
          name: android-release

      - name: 下载 Windows 产物
        if: needs.build-windows.result == 'success'
        uses: actions/download-artifact@v4
        with:
          name: windows-release

      - name: 下载 macOS 产物
        if: needs.build-macos.result == 'success'
        uses: actions/download-artifact@v4
        with:
          name: macos-release

      - name: 下载 Linux 产物
        if: needs.build-linux.result == 'success'
        uses: actions/download-artifact@v4
        with:
          name: linux-release

      - name: 准备发布文件
        run: |
          mkdir -p release_assets
          [ -f app-release.apk ] && cp app-release.apk release_assets/
          [ -f windows-release.zip ] && cp windows-release.zip release_assets/
          [ -f macos-release.zip ] && cp macos-release.zip release_assets/
          [ -f linux-release.zip ] && cp linux-release.zip release_assets/
          ls -la release_assets/

      - name: 创建 Release 并上传产物
        uses: softprops/action-gh-release@v2
        with:
          tag_name: v${{ needs.prepare.outputs.version }}
          name: Release v${{ needs.prepare.outputs.version }}
          generate_release_notes: true
          files: release_assets/*
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
