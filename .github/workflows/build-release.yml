# 手动构建并发布 Windows / Android Release 到 GitHub
# 版本号格式: 1.YYYYMMDDHHmm（如 1.202601011200）
# 在 Actions 页选择此 workflow，点击 Run workflow，选择平台后运行

name: Build Release (Windows / Android)

on:
  workflow_dispatch:
    inputs:
      platform:
        description: '构建平台 (android=仅 APK, windows=仅 Windows, both=双平台)'
        required: true
        default: 'both'
        type: choice
        options:
          - android
          - windows
          - both

env:
  FLUTTER_VERSION: '3.24.0'
  PROJECT_DIR: flutter_app

jobs:
  prepare:
    name: 生成版本号
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.version.outputs.version }}
    steps:
      - name: 生成版本号 (1.YYYYMMDDHHmm)
        id: version
        run: |
          TIMESTAMP=$(date -u +%Y%m%d%H%M)
          echo "version=1.${TIMESTAMP}" >> $GITHUB_OUTPUT
          echo "Generated version: 1.${TIMESTAMP}"

  build-android:
    name: 构建 Android Release
    runs-on: ubuntu-latest
    needs: prepare
    if: ${{ github.event.inputs.platform == 'android' || github.event.inputs.platform == 'both' }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: 安装 Java 17
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'

      - name: 安装 Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}
          cache: true

      - name: 获取依赖
        working-directory: ${{ env.PROJECT_DIR }}
        run: flutter pub get

      - name: 构建 Android APK (Release)
        working-directory: ${{ env.PROJECT_DIR }}
        run: flutter build apk --release

      - name: 上传 Android 产物
        uses: actions/upload-artifact@v4
        with:
          name: android-release
          path: ${{ env.PROJECT_DIR }}/build/app/outputs/flutter-apk/app-release.apk

  build-windows:
    name: 构建 Windows Release
    runs-on: windows-latest
    needs: prepare
    if: ${{ github.event.inputs.platform == 'windows' || github.event.inputs.platform == 'both' }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: 安装 Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}
          cache: true

      - name: 获取依赖
        working-directory: ${{ env.PROJECT_DIR }}
        run: flutter pub get

      - name: 构建 Windows (Release)
        working-directory: ${{ env.PROJECT_DIR }}
        run: flutter build windows --release

      - name: 打包 Windows 发布目录
        shell: pwsh
        run: |
          Compress-Archive -Path "${{ env.PROJECT_DIR }}\build\windows\x64\runner\Release\*" -DestinationPath windows-release.zip -Force

      - name: 上传 Windows 产物
        uses: actions/upload-artifact@v4
        with:
          name: windows-release
          path: windows-release.zip

  release:
    name: 创建 GitHub Release
    runs-on: ubuntu-latest
    needs: [prepare, build-android, build-windows]
    if: |
      always() &&
      (needs.build-android.result == 'success' || needs.build-android.result == 'skipped') &&
      (needs.build-windows.result == 'success' || needs.build-windows.result == 'skipped') &&
      (needs.build-android.result == 'success' || needs.build-windows.result == 'success')
    permissions:
      contents: write
    steps:
      - name: 下载 Android 产物
        if: needs.build-android.result == 'success'
        uses: actions/download-artifact@v4
        with:
          name: android-release

      - name: 下载 Windows 产物
        if: needs.build-windows.result == 'success'
        uses: actions/download-artifact@v4
        with:
          name: windows-release

      - name: 准备发布文件
        run: |
          mkdir -p release_assets
          [ -f app-release.apk ] && cp app-release.apk release_assets/
          [ -f windows-release.zip ] && cp windows-release.zip release_assets/
          ls -la release_assets/

      - name: 创建 Release 并上传产物
        uses: softprops/action-gh-release@v2
        with:
          tag_name: v${{ needs.prepare.outputs.version }}
          name: Release v${{ needs.prepare.outputs.version }}
          generate_release_notes: true
          files: release_assets/*
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
